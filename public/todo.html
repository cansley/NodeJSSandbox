<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Simple Todo List</title>
</head>
<body>
<div id='itemList'></div>
<form id="addForm" action="http://localhost:3000/todo">
    <input type="text" id="newItem" name="newItem">
    <button id="addBtn">Add Item</button>
</form>
</body>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script lang="javascript">
    function doAjaxGet(url, callback){
        $.ajax({
            cache: false,
            type: "get",
            url: url,
            success: function(data){
                // do stuff here...
                callback(data);
            },
            error: function(jqXHR, textStatus, errorThrown){
              callback("Error: " + errorThrown);
            }
        });
    }

    function doAjaxDelete(url, callback){
        $.ajax({
            cache: false,
            type: "delete",
            url: url,
            success: function(data){
                callback(data);
            },
            error: function(jqXHR, textStatus, errorThrown){
                callback("Error: " + errorThrown);
            }
        });
    }

    function __doFormPostAjax(eventTarget, callback) {
        var theform = __getForm(eventTarget);
        var formData = $(theform).serialize();
        $.ajax({
            cache: false,
            type: "post",
            url: $(theform).attr("action"),
            data: formData,
            success: function (msg) {
                callback(msg);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                callback("Server side call failed. " + errorThrown);
            }
        });
    }
    function __getForm(eventTarget) {
        var element = __getElement(eventTarget);
        return $(element).closest('form').first();
    }
    function __getElement(eventTarget) {
        var element;
        if (eventTarget.split) {
            element = $(eventTarget);
            if (element.size() == 0 && /^(\w|-)+$/.test(eventTarget)) {
                //extra help for callers that don't make a valid selector => look by id and then by name
                element = $("#" + eventTarget);
                if (element.size() == 0) {
                    element = $('[name=' + eventTarget + "]");
                }
            }
        } else {
            element = $(eventTarget);
        }
        return element;
    }

    function initializeList(){
        doAjaxGet("http://localhost:3000/todo", function(msg){
            var itemList = $("#itemList");
            itemList.empty();
            var ul = $('<ul/>').appendTo("#itemList");
            if (msg.items.length == 0){
                $('<li/>').appendTo(ul).html("<i>No Items Found</i>");
            }
            msg.items.forEach(function(item){
                var html = item.Value + '<img id="' + item.idx + '" src="/images/delete.png" class="itemDelete"/>';
                $('<li/>').appendTo(ul).attr('id', item.idx).attr('name', item.idx).html(html);
            });

            $('.itemDelete').unbind('click');
            $('.itemDelete').click(deleteItem);
            var input = $('#newItem');
            input.val('');
            input.focus();
        });
    }

    function deleteItem(event){
        var item = event.target.id;
        var url = "http://localhost:3000/todo/" + item;
        doAjaxDelete(url, function(msg){
            // should check for errors here...
            initializeList();
        });
    }

    $(document).ready(function(){
        initializeList();
        $('addForm').submit(function(event){
            event.preventDefault();
        });
        $('#addBtn').click(function(event){
            event.preventDefault();
            __doFormPostAjax("addForm", function(msg){
                initializeList();
            });
        });
    });
</script>
</html>